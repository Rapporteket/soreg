---
title: "Resultatportalen"
author: "Hannu"
date: "9 6 2021"
output: 
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: fill
runtime: shiny   
---
  
```{r global, include=FALSE}
library(tidyverse)
library(lubridate)
library(datasets)
library(ggplot2)
library(tidyr)
library(dplyr)
library(DT)
library(purrr)
library(stringr)
library(magrittr)

library(rapwhale)
library(flexdashboard)
library(shinyWidgets)

grunnmappe = "\\\\ihelse.net\\kvalitetsregister\\HBE\\2013-1189\\"
datamappe = paste0(grunnmappe, "Datadumpar-ny-struktur\\")
oldmappe = paste0(grunnmappe, "datadumpar\\")
hjemmappe ="H://R/"
flexmappe =paste0(hjemmappe, "flex")
rpmappe = paste0(hjemmappe, "resultatportalen")
sleevemappe="H://Sleeve/"

# AVNmappe=paste0(grunnmappe,"Henrik\\2020-07-15\\")   #  spesial for tromboseprofylakse

# Hent datoen til siste tilgjengelege uttrekk
# dato_uttrekk = "2020-07-03"                   # på datamappe finns ev-dumpene

# Hent datoen til siste tilgjengelege uttrekk
dato_uttrekk = list.dirs(oldmappe, recursive = FALSE, full.names = FALSE) %>%
  sort %>%
  last %>% 
  as.Date
# Adressa til den siste datafila
mappe = paste0(oldmappe, dato_uttrekk)
filnamn =   paste0("SOReg_DatadumpArsrapport_datadump_",dato_uttrekk,".csv")  
adresse_Arsrapport = paste0(mappe, "\\", filnamn)

# Les inn data
# Manuell (æsj!) spesifikasjon av kolonnetypar
# (fordi me manglar kodebok for denne datadumpen)
kol_typar = cols(
  PasientID = col_integer(),
  Fodselsdato = col_date(),
  PasientAlder = col_number(),
  PasientKjonn = col_character(),
  OpererendeRESH = col_character(),
  OperererendeSykehus = col_character(),
  BR_BesoksDato = col_date(),
  BR_Vekt = col_integer(),
  BR_Hoyde = col_integer(),
  BR_BMI = col_double(),
  BR_Systolisk = col_integer(),
  BR_Diastolisk = col_integer(),
  BR_PaagaaendeBeh = col_integer(),
  BR_SovnApne = col_integer(),
  BR_Hypertoni = col_integer(),
  BR_Diabetes = col_integer(),
  BR_DiabetesSidenAar = col_integer(),
  BR_Typediabetesbeh = col_integer(),
  BR_Typediabetesbehv2 = col_integer(),
  BR_Dyslipidemi = col_integer(),
  BR_Dyspepsi = col_integer(),
  BR_Diare = col_integer(),
  BR_Depresjon = col_integer(),
  BR_MuskelSkjelettsmerter = col_integer(),
  BR_AnnenSykdom = col_integer(),
  BR_fsglukose = col_double(),
  BR_B_HbA1c = col_double(),
  BR_S_LDL = col_double(),
  BR_Finansiering = col_integer(),
  ForlopsID = col_integer(),
  OperasjonsID = col_integer(),
  Operasjonsdato = col_date(),
  OperasjonVekt = col_integer(),
  TidlFedmeOp = col_integer(),
  GastroUtfort = col_integer(),            #?
  Operasjonsmetode = col_integer(),
  Opmetode_GBP = col_integer(),             #  virket ikke likevel etter fjernet 00:00
  IdenHiatusernie = col_integer(),
  OP_PeropKompl = col_integer(),
  OP_AnnenSamtidigOp = col_integer(),
  OP_GETeknikk = col_integer(),
  OP_AvstTreitzGE = col_integer(),
  OP_CommonChannel = col_integer(),
  OP_CommonChannelCm = col_integer(),
  OP_GSBougiediameter = col_integer(),
  OP_GSAvstPylorus = col_integer(),
  OP_GSForsterket = col_integer(),
  OP_GSPexiAvCardia = col_integer(),
  OP_BDPBougiediam = col_integer(),
  OP_BDPCommonChannel = col_integer(),
  OP_BDPAlimentaryLimb = col_integer(),
  UtskrivelsesDato = col_date(),
  LiggeDogn = col_integer(),
   u6_Vekt = col_integer(),
   u6_Hoyde = col_integer(),
   u6_RESH = col_character(),
   u6_KontrollType = col_integer(),
   u6_Ferdigstill = col_integer(),  #?
  a1_KontrollDato = col_date(),          ####
  a1_BehAnnetSykehus = col_integer(),
  a1_Substitusjon = col_integer(),
  a1_OpSidenSist = col_integer(),
  a1_Komplikasjoner = col_integer(),
  a1_Vekt = col_integer(),
  a1_Hoyde = col_integer(),
  a1_Systolisk = col_integer(),
  a1_Diastolisk = col_integer(),
  a1_PaagaaendeBeh = col_integer() , #?
  a1_SovnApne = col_integer(),
  a1_Hypertoni = col_integer(),
  a1_Diabetes = col_integer(),
  a1_DiabetesBehType = col_integer(),
  a1_DiabetesBehTypev2 = col_integer(),
  a1_Dyslipidemi = col_integer(),
  a1_Dyspepsi = col_integer(), 
  a1_Diare = col_integer(),
  a1_Depresjon = col_integer(),
  a1_MuskelSkjelettsmerter = col_integer(),
  a1_AnnenSykdom = col_character(),
  a1_fP_Glukose = col_double(),
  a1_BHbA1c = col_double(),
  a1_P_LDL = col_double(),
  # a1_Dyslipidemi = col_double(),
  a1_RESH = col_character(),
  a1_KontrollType = col_integer(),
#  `1Aar_OppfolgingsType` = col_integer(),  ##?
  a1_BMI = col_double(),
  a1_RevisionsOp = col_integer(),
  o_sg_gkl_sut = col_integer(),
  o_rygbp_pet_luk = col_integer(),
  o_samt_crurapl = col_integer(),
  o_samt_adhl = col_integer(),
  o_samt_adhl = col_integer(),
   u6_Substitusjon = col_integer(),
   u6_KomplAlvorGrad = col_integer(),
   u6_Behandling30Dager = col_integer(),
  BR_HenvisningsDato = col_date(),
  BR_OpBestDato = col_date(),
  a2_KontrollDato = col_datetime(), ####  !!!
  a2_Vekt = col_integer(),
  a2_Hoyde = col_integer(),
  a2_Systolisk = col_double(),
  a2_Diastolisk = col_double(),
   a2_PaagaaendeBeh = col_integer() , #?
  a2_SovnApne = col_integer(),
  a2_Hypertoni = col_integer(),
  a2_Diabetes = col_integer(),
  a2_DiabetesBehType = col_integer(),
  a2_DiabetesBehTypev2 = col_integer(),  # ?? 2ar
  a2_Dyslipidemi = col_integer(),
  a2_Dyspepsi = col_integer(), 
  a2_Diare = col_integer(),
  a2_Depresjon = col_integer(),
  a2_MuskelSkjelettsmerter = col_integer(),
  a2_AnnenSykdom = col_character(),
    a2_fP_Glukose = col_double(),
  a2_BHbA1c = col_double(),
  a2_P_LDL = col_double(),
  a2_KontrollType = col_integer(),
# a2_OppfolgingsType` = col_integer(),   ## ??
  a2_BMI = col_double(),
  PasUtgatt = col_integer(),
  a2_RevisionsOp = col_integer()
)

d_full = read_delim(
  adresse_Arsrapport,
  delim=";",
  na = "null",
  locale = locale(date_format = "%Y-%m-%d", decimal_mark = ","),
  col_types = kol_typar
)
# Legg til info om operasjonsår
d_full %<>% mutate(op_aar = year(Operasjonsdato),
                   op_primar = (TidlFedmeOp==0))
# Rekn ut BMI for alle tidspunkta
# Merk: Ein registrerer kroppshøgd på alle tidspunkta *utanom*
#       for operasjonstidspunktet! Me har altså kroppsvekt ved
#       baseline, 6 veker etter operasjon, 1 år etter operasjon,
#       2 år etter operasjon osv., men ikkje *ved* operasjon.
#       Der har me berre vekt (men heller ikkje for alle, for
#       operasjonsvekt er ikkje obligatorisk!).
#
#       Derfor må me ta ein spansk ein og bruka
#       kroppshøgd ved *baseline* for utrekning
#       av BMI på operasjonstidspunktet. :(
 d_full %<>% mutate(bmi_baseline = BR_Vekt/(BR_Hoyde/100)^2,
                           bmi_op = OperasjonVekt/(BR_Hoyde/100)^2,
                           bmi_6v = u6_Vekt/(u6_Hoyde/100)^2,
                           bmi_1a = a1_Vekt/(a1_Hoyde/100)^2,
                           bmi_2a = a2_Vekt/(a2_Hoyde/100)^2,
                          BR_SovnApne  =   ifelse(BR_PaagaaendeBeh==0, 0, BR_SovnApne),   # samme sak for 1Aar, 2Aar
                          BR_Hypertoni  =   ifelse(BR_PaagaaendeBeh==0, 0, BR_Hypertoni),
                          BR_Diabetes  =   ifelse(BR_PaagaaendeBeh==0, 0, BR_Diabetes),
                          BR_Dyslipidemi  =   ifelse(BR_PaagaaendeBeh==0, 0, BR_Dyslipidemi),
                          BR_Dyspepsi  =   ifelse(BR_PaagaaendeBeh==0, 0, BR_Dyspepsi),
                          BR_Depresjon  =   ifelse(BR_PaagaaendeBeh==0, 0, BR_Depresjon),
                          BR_MuskelSkjelettsmerter  =   ifelse(BR_PaagaaendeBeh==0, 0, BR_MuskelSkjelettsmerter),
                           a1_SovnApne  =   ifelse(a1_PaagaaendeBeh==0, 0, a1_SovnApne),   # samme sak for 1Aar, 2Aar
                          a1_Hypertoni  =   ifelse(a1_PaagaaendeBeh==0, 0, a1_Hypertoni),
                          a1_Diabetes  =   ifelse(a1_PaagaaendeBeh==0, 0, a1_Diabetes),
                          a1_Dyslipidemi  =   ifelse(a1_PaagaaendeBeh==0, 0, a1_Dyslipidemi),
                          a1_Dyspepsi  =   ifelse(a1_PaagaaendeBeh==0, 0, a1_Dyspepsi),
                          a1_Depresjon  =   ifelse(a1_PaagaaendeBeh==0, 0, a1_Depresjon),
                          a1_MuskelSkjelettsmerter =   ifelse(a1_PaagaaendeBeh==0, 0, a1_MuskelSkjelettsmerter),
                           a2_SovnApne  =   ifelse(a2_PaagaaendeBeh==0, 0, a2_SovnApne),   # samme sak for 1Aar, 2Aar
                          a2_Hypertoni  =   ifelse(a2_PaagaaendeBeh==0, 0, a2_Hypertoni),
                          a2_Diabetes  =   ifelse(a2_PaagaaendeBeh==0, 0, a2_Diabetes),
                          a2_Dyslipidemi  =   ifelse(a2_PaagaaendeBeh==0, 0, a2_Dyslipidemi),
                          a2_Dyspepsi  =   ifelse(a2_PaagaaendeBeh==0, 0, a2_Dyspepsi),
                          a2_Depresjon  =   ifelse(a2_PaagaaendeBeh==0, 0, a2_Depresjon),
                          a2_MuskelSkjelettsmerter  =   ifelse(a2_PaagaaendeBeh==0, 0, a2_MuskelSkjelettsmerter)
                          )


# Data for alle år opptil (og inkludert) rapporteringsår,
# men ikkje for seinare år
#
# (Brukar '< dato + 1' i staden for '<= dato' for å handtera
# det rett dersom ein i framtida endrar operasjonsdato
# til å vera operasjonstidspunkt i staden for operasjondato
# (ein dato tolka som tidspunkt er klokka 00:00 den aktuelle
# datoen, ikkje 24:00, og inkluderer derfor ikkje tidsperioden
# frå 00:00 til 24:00, så me ville mista det siste døgnet).)
rapporteringsaar = 2019
dato_opptilrapaar = as_date(paste0(rapporteringsaar, "-12-31")) # For ev. seinare bruk i teksten
d_opptilrapaar = d_full %>% 
  filter(Operasjonsdato < (dato_opptilrapaar + 1))

# Data for alle år opptil (og inkludert) to år før rapporteringsåret,
# dvs. alle data me i teorien burde ha toårs oppfølgingsdata på
dato_toaarsdata = as_date(paste0(rapporteringsaar - 2, "-12-31")) # For ev. seinare bruk i teksten
d_toaarsdata = d_full %>% 
  filter(Operasjonsdato < (dato_toaarsdata + 1))

# Og tilsvarande for eittårsdata
dato_eittaarsdata = as_date(paste0(rapporteringsaar - 1, "-12-31")) # For ev. seinare bruk i teksten
d_eittaarsdata = d_full %>% 
  filter(Operasjonsdato < (dato_eittaarsdata + 1))

# Dei som vart operert det aktuelle året
d = d_full %>%  filter(op_aar == rapporteringsaar)

# Talet på operasjonsmåtar
n_op = nrow(d_full)
n_pas = n_distinct(d$PasientID)

# d_prim = d %>% filter(op_primar)  
d_prim = d_full %>% filter(op_primar)    
d_reop = d_full %>% filter(!op_primar)    


# I nokre analysar ser me berre på dei som har 6-vekesoppfølging
# registrert. Hentar ut eiga datasett for desse
d_prim_6v = d_prim %>% filter(u6_KontrollType %in% 1:3)

d_toaarsdata_prim = d_toaarsdata %>% filter(op_primar)
d_eittaarsdata_prim = d_eittaarsdata %>% filter(op_primar)
maksdogn_vis = 14
 
# Talet på primæroperasjonar og reoperasjonar
n_prim = nrow(d_prim)
n_reop = n_op - n_prim
```


```{r liggetid} 
# Kva var den vanlegaste talet døgn å ligga etter operasjon
liggedogn_typetal = d_prim_6v %>%
  count(LiggeDogn) %>%
  arrange(desc(n)) %$%
  LiggeDogn %>%
  first

# funksjon for å regne ut kvalitetsindikatoren
# definert for liggetid (andel pasienter med 3 dager eller færre)
ki_liggetid = function(df){
  
  teljar = sum(df$LiggeDogn <= 3)
  nemnar = nrow(df)
  
  ind = teljar/nemnar
  
  res = tibble(# forklaring="Del pasienter med 3 eller færre liggedøgn",
               # ltx_tekst = "Tre/færre liggedøgn",
               teljar, nemnar, ind = ind) # trenger ikke å definere at
                          # variabler som er med i en group_by
                          # skal være med, de kommer uansett
  res            
}

# Kor mange låg mindre enn fire døgn
p_kortligg = ki_liggetid(d_prim_6v)$ind

# Kor mange låg mindre enn fire døgn per sjukehus
d_kortligg_sjuk = d_prim_6v %>% 
  group_by(OperererendeSykehus, op_aar) %>% 
  do(ki_liggetid(.)) %>% 
  arrange(desc(ind))

kortligg_sh <- function(sh) {d_kortligg_sjuk %>% filter(OperererendeSykehus %in% sh)}
kortligg_yr <- function(yr) {d_kortligg_sjuk %>% filter(op_aar %in% yr)}
kortligg    <- function(sh,yr){d_kortligg_sjuk %>% filter(OperererendeSykehus %in% sh, op_aar %in% yr)}
```
 
```{r reinnleggelse}
# I analysar for reinnlegging ser me berre på dei som har 6-vekesoppfølging
# registrert eller som er registrert som reinnlagd til trass for at dei
# ikkje har 6-vekesoppfølging (jf. forklaringstekst for reinnleggings-
# indikatoren i årsrapporten). Hentar ut eiga datasett for desse. Men det
# viser seg at det òg er mogleg å svara «Vet ikke» (verdi 2) på om pasienten
# vart reinnlagd. Desse gjev ingen informasjon, og vert derfor òg fjerna.
d_reinn = d_prim %>% filter(((u6_KontrollType %in% 1:3) |
                             (u6_Behandling30Dager == 1)) &
                             (u6_Behandling30Dager != 2))

# Tilsvarande for alvorlege komplikasjonar
d_kompl = d_prim %>% filter((u6_KontrollType %in% 1:3) | (!is.na(u6_KomplAlvorGrad)))


# funksjon for å regne ut
# andel pasienter som får innleggelse innen 30 dager etter
# operasjonen
ki_30dager = function(df){

  teljar = sum(df$u6_Behandling30Dager == 1)
  nemnar = nrow(df)
  
  ind = teljar/nemnar
  
  res = tibble(#forklaring = "Reinnlegging innan 30 dagar etter operasjonen", 
               #ltx_tekst = "Reinnlegging",
               teljar, nemnar, ind = ind)
  res   
  
}
# andel pasienter som får innleggelse innen 30 dager etter operasjon
p_30reinnlegg = ki_30dager(d_reinn)

# andel pasienter som får innleggelse innen 30 dager etter operasjon per sjukehus
d_innlegg30 = d_reinn %>% group_by(OperererendeSykehus, op_aar) %>% do(ki_30dager(.)) %>% arrange(desc(ind))
innl30_sh <- function(sh) {d_innlegg30 %>% filter(OperererendeSykehus %in% sh)}
innl30_yr <- function(yr) {d_innlegg30 %>% filter(op_aar %in% yr)}
innl30 <- function(sh,yr){d_innlegg30 %>% filter(OperererendeSykehus %in% sh, op_aar %in% yr)}
```

```{r komplikasjon}
# funksjon for å regne ut
# andel pasienter som får en alvorlig komplikasjon
ki_kompl_alv =function(df){
  
  # Alvorlege komplikasjonar
  teljar = sum(df$u6_KomplAlvorGrad >= 4, na.rm=TRUE)
  nemnar = nrow(df)

  ind = teljar/nemnar
  
  res = tibble(#forklaring = "Alvorlege komplikasjonar 30 dagar etter operasjonen", 
               #ltx_tekst = "Alvorlege kompl.",
                            teljar, nemnar, ind = ind) # trenger ikke å definere at
                          # variabler som er med i en group_by
                          # skal være med, de kommer uansett
  res   
  
}
# andel pasienter som får en alvorlig komplikasjon
p_kompl_alv = ki_kompl_alv(d_kompl)

# andel pasienter som får en alvorlig komplikasjon per sjukehus
d_kompl_alv_sjukehus = d_kompl %>% group_by(OperererendeSykehus,op_aar) %>% do(ki_kompl_alv(.)) %>% arrange(desc(ind))

kompl_sh <- function(sh) {d_kompl_alv_sjukehus %>% filter(OperererendeSykehus %in% sh)}
kompl_yr <- function(yr) {d_kompl_alv_sjukehus %>% filter(op_aar %in% yr)}
kompl <- function(sh,yr){d_kompl_alv_sjukehus %>% filter(OperererendeSykehus %in% sh, op_aar %in% yr)}
```
 
 
```{r aarskontrollar}
####################################################
# +-90                                             #  slingringsmonn
nitti_m  <-  function(yr=1, dag= today(), l=90) { dag-ddays(l)+years(yr) }             
nitti_p  <-  function(yr=1, dag= today(), l=90) { dag+ddays(l)+years(yr) }
nitti    <-  function(yr=1, dag= today(), l=90) { c(dag-ddays(l)+years(yr), dag+ddays(l)+years(yr)) }

dmx <- d_full   # alle operasjoner for kontrollene
dm  <- dmx   %>%  mutate( et_nor_m = nitti_m(dag= Operasjonsdato), et_nor_p = nitti_p(dag= Operasjonsdato),
                          to_nor_m = nitti_m(yr=2, dag= Operasjonsdato), to_nor_p = nitti_p(yr=2, dag= Operasjonsdato),
                          pTWL = 100*(BR_Vekt - a2_Vekt)/BR_Vekt )

dn <-  dm %>% mutate(et_nt= a1_KontrollDato %within% interval( et_nor_m, et_nor_p ),
                     to_nt= a2_KontrollDato %within% interval( to_nor_m, to_nor_p ),
                     et_b4= a1_KontrollDato %within% interval( Operasjonsdato+1, et_nor_m-1 ),
                     et_lt= a1_KontrollDato > et_nor_p,
                     to_b4= a2_KontrollDato %within% interval( Operasjonsdato+1, to_nor_m-1 ),
                     to_lt= a2_KontrollDato > to_nor_p)
 
dt    <-  dn %>% select(  c("PasientID", "OperererendeSykehus", "Operasjonsdato", "op_aar", "Operasjonsmetode", "Opmetode_GBP",
                           "et_b4", "et_nt", "et_lt", "to_b4",  "to_nt", "to_lt", "pTWL", "op_primar"))
#                           "fs1_gj_kt", "fs1_u_kt", "fs2_gj_kt", "fs2_u_kt", "pTWL"))

# fedmerelatert
du    <-  dm %>% select("BR_SovnApne" ,"BR_Hypertoni" ,"BR_Diabetes","BR_Dyslipidemi",
                        "BR_Dyspepsi" ,"BR_Depresjon","BR_MuskelSkjelettsmerter")
fr <-  colSums(du,na.rm = TRUE) /nrow(du)
fr <- sort(fr,decr=T)
last_opday <- max(dt$Operasjonsdato)
k1_last <- last_opday - months(15)
k2_last <-  last_opday - months(27)

# k1_dt <- dt %>% filter(Operasjonsdato < k1_last) %>% group_by(OperererendeSykehus) %>% mutate(ops = n())
# k2_dt <- dt %>% filter(Operasjonsdato < k2_last) %>% group_by(OperererendeSykehus) %>% mutate(ops = n())

ki_k1nt = function(df){
  df <- df %>% filter(Operasjonsdato < k1_last)
  teljar = sum(df$et_nt, na.rm = TRUE)
  nemnar = nrow(df)
  
  ind = teljar/nemnar
  
  res = tibble( teljar, nemnar, ind = ind)   # 
   res            
}

ki_k2nt = function(df){
  df <- df %>% filter(Operasjonsdato < k2_last)
  teljar = sum(df$et_nt, na.rm = TRUE)
  nemnar = nrow(df)
  
  ind = teljar/nemnar
  
  res = tibble( teljar, nemnar, ind = ind)   # 
   res            
}

# andel pasienter som får en alvorlig komplikasjon
#p_kompl_alv = ki_kompl_alv(d_kompl)

# andel pasienter som får en alvorlig komplikasjon per sjukehus
#d_kompl_alv_sjukehus = d_kompl %>% group_by(OperererendeSykehus,op_aar) %>% do(ki_kompl_alv(.)) %>% arrange(desc(ind))
d_k1_sjukehus = dt %>% group_by(OperererendeSykehus, op_aar) %>% do(ki_k1nt(.)) %>% arrange(desc(ind))
d_k2_sjukehus = dt %>% group_by(OperererendeSykehus, op_aar) %>% do(ki_k2nt(.)) %>% arrange(desc(ind))

k1nt  <-  dt %>% filter(Operasjonsdato < k1_last) %>% 
                 group_by(OperererendeSykehus, op_aar) %>% 
                 mutate(ops = n()) %>% 
                 summarise(ktr1 = sum(et_nt, na.rm = T),oprs = ops[1],kt1 = sum(et_nt, na.rm = T)/ ops[1]) 

k2nt  <-  dt %>% filter(Operasjonsdato < k2_last) %>% 
                 group_by(OperererendeSykehus,op_aar) %>% 
                 mutate(ops = n()) %>% 
                 summarise(ktr2 = sum(to_nt, na.rm = T),oprs = ops[1],kt2 = sum(to_nt, na.rm = T)/ ops[1]) 

k1_sh <- function(sh) {k1nt %>% filter(OperererendeSykehus %in% sh)}
k1_yr <- function(yr) {k1nt %>% filter(op_aar %in% yr)}
k2_sh <- function(sh) {k2nt %>% filter(OperererendeSykehus %in% sh)}
k2_yr <- function(yr) {k2nt %>% filter(op_aar %in% yr)}

k1 <- function(sh,yr) {k1nt %>% filter(OperererendeSykehus %in% sh, op_aar %in% yr)}
k2 <- function(sh,yr) {k2nt %>% filter(OperererendeSykehus %in% sh, op_aar %in% yr)}
```

```{r TWL20}
d_GS    <- dt %>% filter(Operasjonsmetode == 6)
d_RYGBP    <- dt %>% filter(Operasjonsmetode == 1, Opmetode_GBP == 1)   # mini = Opmetode_GBP
d_OAGB    <- dt %>% filter(Operasjonsmetode == 1, Opmetode_GBP == 2)

d_TWL  <- dt %>% filter(Operasjonsmetode %in% c(1,6)) %>% filter(!is.na(pTWL)) %>% mutate(del20 = pTWL>=20.0)  # pTWL at 2 year must exist!  to_nt == TRUE
d_slv  <- d_TWL %>% filter(Operasjonsmetode==6)
d_gbp  <- d_TWL %>% filter(Operasjonsmetode==1, Opmetode_GBP==1)
d_oa   <- d_TWL %>% filter(Operasjonsmetode==1, Opmetode_GBP==2)     

detail    <-  function(dmx) {dmx %>% group_by(OperererendeSykehus, op_aar)}
shw       <-  function(dmx) {dmx %>% tbl_df %>% rmarkdown::paged_table()}

slv20   <-    detail(d_slv) %>% summarise("tyve"= sum(del20, na.rm = TRUE),  "ops"=n(), "minst20" = mean(del20, na.rm = TRUE))
gbp20   <-    detail(d_gbp) %>% summarise("tyve"= sum(del20, na.rm = TRUE),  "ops"=n(), "minst20" = mean(del20, na.rm = TRUE))
 oa20   <-    detail(d_oa)  %>% summarise("tyve"= sum(del20, na.rm = TRUE),  "ops"=n(), "minst20" = mean(del20, na.rm = TRUE))

slvdel20 <- function(sh,yr) {slv20 %>% filter(OperererendeSykehus %in% sh, op_aar %in% yr)}
gbpdel20 <- function(sh,yr) {gbp20 %>% filter(OperererendeSykehus %in% sh, op_aar %in% yr)}
 oadel20 <- function(sh,yr) { oa20 %>% filter(OperererendeSykehus %in% sh, op_aar %in% yr)}

 
 
op_15m   <- dt %>% filter(Operasjonsdato<k1_last) %>% group_by(OperererendeSykehus) %>%  summarise("ops"=n())
op_27m   <- dt %>% filter(Operasjonsdato<k2_last) %>% group_by(OperererendeSykehus) %>%  summarise("ops"=n())

#           tb20 tabell for årsrapporten  
tb <-          dt %>% group_by(OperererendeSykehus) %>% 
                      summarise( "to år %TWL"= mean(pTWL, na.rm = TRUE)) 

tb20 <-        dt %>% mutate(del20 = pTWL>=20.0 )  %>% group_by(OperererendeSykehus) %>% 
                     summarise("ops"=n(), "del %TWL>=20.0"= mean(del20, na.rm = TRUE))

tb20toar <-        dt %>% mutate(del20 = pTWL>=20.0 ) %>% filter(to_nt)  %>% group_by(OperererendeSykehus) %>% 
                         summarise("ops"=n(), "del %TWL>=20.0"= mean(del20, na.rm = TRUE))


tb20_GS <-        d_GS %>% mutate(del20= pTWL>=20.0 ) %>% filter(to_nt) %>% group_by(OperererendeSykehus) %>% 
                           summarise("ops"=n(),  "del %TWL>=20.0"= mean(del20,na.rm = TRUE))

tb20_RYGBP <-        d_RYGBP %>% mutate(del20= pTWL>=20.0 ) %>% filter(to_nt) %>% group_by(OperererendeSykehus) %>% 
                                summarise("ops"=n(),  "del %TWL>=20.0"= mean(del20,na.rm = TRUE))

tb20_OAGB <-        d_OAGB %>% mutate(del20= pTWL>=20.0 )  %>% filter(to_nt) %>% group_by(OperererendeSykehus) %>% 
                              summarise("ops"=n(),  "del %TWL>=20.0"= mean(del20,na.rm = TRUE))


 
tb20b <-    dt %>% mutate(del20= pTWL>=20.0 )  %>% group_by(OperererendeSykehus) %>%
                       mutate(ops = n()) %>% summarise(kt2 = sum(to_nt, na.rm = T)/ ops[1]) 
GS20 <- function(sh,yr) {d_GS %>%  mutate(del20= pTWL>=20.0 ) %>% filter(OperererendeSykehus %in% sh, op_aar %in% yr) %>% group_by(OperererendeSykehus) %>% 
                         filter(to_nt) %>%  summarise("ops"=n(),  "del %TWL>=20.0"= mean(del20,na.rm = TRUE))}
GB20 <- function(sh,yr) {d_RYGBP %>% mutate(del20= pTWL>=20.0 ) %>% filter(OperererendeSykehus %in% sh, op_aar %in% yr) %>% group_by(OperererendeSykehus) %>% 
                         filter(to_nt) %>%  summarise("ops"=n(),  "del %TWL>=20.0"= mean(del20,na.rm = TRUE))} 
```

# Velg {.sidebar data-width=300}
 
```{r}
# shiny inputs defined here
min_dato <-min(dt$Operasjonsdato)
max_dato <-max(dt$Operasjonsdato)
fyrstAar<-year(min_dato) 
sistAar<-year(max_dato)

pickerInput(
      inputId = "sh",
      label = "velg sjukehus",
      choices = unique(dt$OperererendeSykehus),
      multiple = TRUE,
      options = pickerOptions(
        actionsBox = TRUE,
        title = "Please select a hospital",
        header = "This is a list of hospitals"
      )
    )
# sliderInput("ixs", label ="år", min=fyrstAar, max=sistAar, value=c(2017,2018), step=1)
checkboxGroupInput(inputId = "aar", label ="år", choices=fyrstAar:sistAar)  # multiple?
# checkboxGroupInput(inputId = "optype", label ="operasjon", choices=c("primær","revisjon"))
checkboxInput(inputId = "prim", label="primar")
checkboxInput(inputId = "reop", label="revisjon")

# radioButtons("år",label ="years", fyrstAar:sistAar)  # multiple?
# selectInput("sykeh", label="sykehus", unique(dt$OperererendeSykehus),multiple=TRUE)
# selectInput("n_breaks", label = "Number of bins:",
#            choices = c(10, 20, 35, 50), selected = 20)
dateRangeInput('dateRange',
      label = 'Datointerval: yyyy-mm-dd',
      start = min_dato, end = max_dato
    )
```

# %TWL {data-width=700}

### 2 års vekttap-%

```{r}
dmx  <- reactive({    if (input$reop )
        {dt %>% filter(!op_primar) %>% filter(OperererendeSykehus %in% input$sh) %>% filter( op_aar %in% input$aar) %>%
                filter( Operasjonsdato >= input$dateRange[1] ) %>%
                filter( Operasjonsdato  < input$dateRange[2] ) } else if (input$prim )
                {dt  %>% filter(op_primar)   %>% filter(OperererendeSykehus %in% input$sh) %>% filter( op_aar %in% input$aar) %>%
                filter( Operasjonsdato >= input$dateRange[1] ) %>%
                filter( Operasjonsdato  < input$dateRange[2] ) }   else     
                {dt      %>% filter(OperererendeSykehus %in% input$sh) %>% filter( op_aar %in% input$aar) %>%
                filter( Operasjonsdato >= input$dateRange[1] ) %>%
                filter( Operasjonsdato  < input$dateRange[2] ) }
}) 
# hosp <- reactive({paste0("%TWL :",input$sh)})

renderPlot({
#  df_tidy <- gather(dmx$pTWL, cols, value)
ggplot(dmx(), aes(stat='identity', x=pTWL, color=OperererendeSykehus)) + geom_density() +geom_vline(xintercept =20,linetype="dashed",color="black")
})
```


# testing

### logical
```{r}
renderText({input$prim * input$reop})
```


# KI 1 

## Column {data-width=500}

### Liggedøgn
```{r}
lgg <- reactive({kortligg(input$sh, input$aar)})

output$ligge <- renderDataTable({ lgg() }) 
 
DT::dataTableOutput('ligge')
```

## Column {data-width=500}

### Del pasientar med tre eller færre liggedøgn etter operasjon.  
Liggetid etter operasjon kan gje ein indikasjon på korleis pasientane
har det etter operasjonen og om det har oppstått komplikasjonar
som krev lengre tid på sjukehuset. Tala for 2019 viser at 97 % av
pasientane hadde tre eller færre postoperative liggedøgn.

# KI 2

## Column {data-width=500}

### Reinnleggelse 30d
```{r}
innlgg <- reactive({innl30(input$sh, input$aar)})

output$innl <- renderDataTable({ innlgg() }) 
 
DT::dataTableOutput('innl')
```

## Column {data-width=500}

### Del pasientar som har blitt reinnlagt på sjukehus innan 30 dagar etter operasjon.  
Ein annan peikepinn på omfanget av komplikasjonar etter kirurgi
kan ein få ved å måle kor mange som har blitt reinnlagde dei første
30 dagane etter operasjonen. For dei 1 749 pasientane som vi har
reinnleggingsdata på, finn vi 96 (5 %) pasientar som vart reinnlagde
på same eller anna sjukehus innan 30 dagar etter operasjonen


# KI 3 

## Column {data-width=500}

### Komplikasjonar 30d
```{r}
kmpl <- reactive({kompl(input$sh, input$aar)})

output$kpl <- renderDataTable({ kmpl() }) 
 
DT::dataTableOutput('kpl')
```

## Column {data-width=500}

### Del pasientar som får alvorlege komplikasjonar dei første 30 dagane etter operasjonen.  
Det oppstod alvorlege komplikasjonar (alvorsgrad IIIb eller høgare
etter Clavien–Dindo-klassifikasjonen2) etter 32 (2 %) av operasjonane.
Figur 3.2 gjev ei oversikt over alle komplikasjonane. Det var ikkje
registrert dødsfall dei første 30 dagane etter operasjon.

# KI 4 

## Column {data-width=500}

### Kontroll 1 år
```{r}
koo1 <- reactive({k1(input$sh, input$aar)  %>% arrange(desc(kt1)) })

output$kei1 <- renderDataTable({ koo1() }) 
 
DT::dataTableOutput('kei1')
```


## Column {data-width=500}

### Del pasientar som blir følgde opp postoperativt innan normtid etter eitt år.  
Denne indikatoren fortel om det er utført eittårskontroll etter operasjon
og om kontrollen vart utført innan normtid. Normtid er her
definert som 365 ± 90 dagar etter operasjon. Pasientar som møter til
regelmessig oppfølging vil kunne få betre grunnlag for å forstå endringane
i livsstil som fedmekirurgi både krev og leiar til. Samstundes kan
god oppfølging gje betre justering og behandling av følgjesjukdom og
føre til tidleg avdekking av mogelege komplikasjonar.


# KI 5  

## Column {data-width=500}

### Kontroll 2 år
```{r}
koo2 <- reactive({k2(input$sh, input$aar) %>% arrange(desc(kt2)) })

output$kei2 <- renderDataTable({ koo2() }) 
 
DT::dataTableOutput('kei2')
```


## Column {data-width=500}

### Del pasientar som blir følgde opp postoperativt innan normtid etter to år.  
Denne indikatoren fortel om det er utført toårskontroll etter operasjon
og om kontrollen vart utført innan normtid. Normtid er her
definert som 730 ± 90 dagar etter operasjon.

# KI 6  

## Column {data-width=500}

### GS, del med %TWL minst 20
Gastric Sleeve
```{r}
GSL <- reactive({slvdel20(input$sh, input$aar)%>% arrange(desc(minst20)) })
output$sleeve <- renderDataTable({ GSL() }) 
DT::dataTableOutput('sleeve')
```


## Column {data-width=500}

### GB, del pasientar med tap av 20% kroppsvekt eller meir (TWL ≥ 20%).  
Gastric Bypass
```{r}
GBP <- reactive({gbpdel20(input$sh, input$aar)%>% arrange(desc(minst20)) })
output$bypass <- renderDataTable({ GBP() }) 
DT::dataTableOutput('bypass')
```



### OAGB, del med %TWL minst 20
One Anastomosis Gastric Bypass
```{r}
OAGB <- reactive({oadel20(input$sh, input$aar)%>% arrange(desc(minst20)) })
output$oagb <- renderDataTable({ OAGB() }) 
DT::dataTableOutput('oagb')
```



# Datatabellar
 
## Column {data-width=150}

### sjukehus
```{r}
renderText(input$sh)
```
### aar
```{r}
renderText(input$aar)
```

 
## Column {data-width=850}

### results
```{r}
vlgt <- reactive({ dt %>% filter( OperererendeSykehus %in% input$sh ) %>% filter( op_aar %in% input$aar) })
kntrl <- reactive({ d_kompl_yr(input$aar)})

output$tble <- renderDataTable({ vlgt() }) 
# output$tble <- renderDataTable({ kntrl() }) 

DT::dataTableOutput('tble')
```

 